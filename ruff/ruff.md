# Ruff

## Содержание

[Что такое ruff?](#Что-такое-ruff?)  
[Formatter: ruff vs black](#Ruff-vs-Black)  
[Ruff linters](#Ruff-linters)  
[Примеры комманд ruff](#Примеры-комманд-ruff)  


----
## Что такое ruff?
Ruff - инструмент для статического анализа кода на Python.   
Помогает находить и исправлять ошибки.   
Ruff умеет форматировать код, но в роли formatter лучше использовать black.  

Ruff включает в себя множество линтеров, которые можно подключать и отключать в конфиге по необходимости.  


----
## Ruff vs Black
Форматирование ruff не сможет всегда обеспечить единообразие кода так, как это сделает black.
А цель форматирования как раз в единообразии.

**Black:**  
Миссия: обеспечить единообразный стиль всего кода, без субъективных решений.  
Поведение: "Code formatter" (Полное форматирование).  
Стиль: Единый, строгий, неизменяемый.  
Автофиксы: Форматирует всё.  
Настраиваемость: Почти нет (ведет себя почти всегда одинаково).  
Работает как механическая перестройка кода: переносы строк, пробелы, скобки, отступы — всё по строгим правилам.  
Игнорирует «красоту» или предпочтения — просто делает однозначно правильное по его правилам форматирование.  
```python
# до black:
def func(x,y):return(x + y)

# после black:
def func(x, y):
    return x + y
```

**Ruff:**  
Миссия: линтинг, т.е. поиск проблем в стиле, структуре, ошибках.  
Поведение: "Linter with fixer".  
Стиль: Конфигурируемый через правила.  
Автофиксы: Только отдельные нарушения.  
Настраиваемость: Много правил, можно включать/выключать.  
Может **частично** исправлять стиль: убрать лишние пробелы, двойные кавычки, пустые строки, и т. д.  
Следует правилам PEP8 + наборам правил (E, F, I, W, UP, и др.).  
Не делает глубокого форматирования, как переносы длинных строк или преобразование однострочных функций в многострочные.  
```python 
# до ruff --fix:
def func(x , y):   return  ( x + y )

# после:
def func(x, y):
    return (x + y)  # скобки останутся, переносов строки — нет
```

Ruff — это вообще не форматтер, а инструмент для линтинга Python-кода, который может автоматически исправлять часть нарушений стиля, но не является полноценным форматтером.


----
## Ruff linters
```bash
$ ruff linter
```

### Базовые линтеры

    F	      Pyflakes            Ошибки: неиспользуемые переменные, импорты, синтаксис — обязателен
    E/W	      pycodestyle         Стиль кода: пробелы, отступы, пустые строки — рекомендуется
    C90	      mccabe              Сложность функций (цикломатическая) — полезно ограничить
    I	      isort               Автосортировка импортов — стандарт
    UP	      pyupgrade           Обновление синтаксиса под актуальный Python — полезно
    RUF	      Ruff-specific       Правила Ruff — auto-fix, улучшения — оставить включённым
    COM           flake8-commas       Анализирует код на наличие правильного использования запятых, особенно в списках, кортежах и других структурах данных.

### Безопасность и баги

    B	     flake8-bugbear	      Предупреждение о потенциальных багах — рекомендуется
    S	     flake8-bandit	      Безопасность: eval, subprocess и т.д. — актуально для prod
    BLE	     blind-except	      Предупреждение о except: без указания — рекомендуется
    FBT	     boolean-trap	      Подозрительные флаги в функциях — полезно, но шумно
    TRY	     tryceratops	      Правильный try/except стиль — можно включить
    SLF	     self	              Предупреждение о доступе к приватным атрибутам — иногда шумный

### Упрощение и стиль

    SIM	     simplify	          Упрощение конструкций — рекомендуется
    C4	     comprehensions	      Оптимизация списковых выражений — полезно
    RET	     return	              Стиль return (избыточность) — по вкусу
    RSE	     raise	              Стиль raise — по вкусу
    G	     logging-format	      Правильные строки логирования — если активно используешь logging
    LOG	     logging	          Общие ошибки при логировании — рекомендуется
    Q	     quotes	              Одинарные/двойные кавычки — по вкусу

### Документация

    D	     pydocstyle	          Проверка docstring — полезно в библиотеках
    DOC	     pydoclint	          Альтернатива D, иногда более строгая

### Типизация

    ANN	     annotations	      Требует type hints в функциях — полезно, если используешь
    TC	     type-checking	      Перенос import typing под if TYPE_CHECKING — продвинуто
    FA	     future-annotations	  Использование from __future__ import annotations

### Проверки кода  

    ERA	     eradicate	          Ищет закомментированный код (# print(...)) — рекомендуется
    FIX	     fixme	              Ищет # TODO, # FIXME — полезно
    TD	     todos	              То же самое — но с более широким подходом
    T10	     debugger	          Ищет pdb, breakpoint() — рекомендуется
    T20	     print	              Ищет отладочный print — особенно для продакшн

### Инфраструткура и импорт

    TID	     tidy-imports	      Предупреждение об относительных импортов — по вкусу
    INP	     no-pep420	          Предотвращение namespace-пакетов без __init__.py
    ICN	     import-conventions	  Именование импортов (import numpy as np)

### Фреймворк и специальные случаи

    DJ	     flake8-django	      Для Django-проектов
    PT	     pytest-style	      Для проектов с pytest
    FAST	     FastAPI	          Специальные правила для FastAPI
    AIR	     Airflow	          Только если ты пишешь DAG’и

### Научные библиотеки

    PD	    pandas-vet	           Предупреждения при использовании pandas
    NPY	    numpy                  Проверка стиля numpy

### Автоматические улучшения

    FLY       flynt	                   Перевод %/.format() в f-строки
    FURB	  refurb	           Умные авто-рефакторинги (экспериментально)
    PERF	  perflint	           Предупреждения о неэффективном коде

### Итоговая рекомендация для общего Python-проекта  
**base**
```toml
select = [
    "E", "F", "D", "Q", "COM"
]
```

**recommended**
```toml
select = [ 
    "F", "E", "W", "C90", "I", 
    "B", "UP", "SIM", "RUF", "ERA", 
    "T10", "T20", "FIX", "RET", "RSE", 
    "BLE", "D", "Q", "COM", 
]
```

| **Код** | **Описание**                                                                 |
|---------|-------------------------------------------------------------------------------|
| "F"     | Pyflakes (ошибки, неиспользуемые переменные и импорты)                       |
| "E"     | pycodestyle (стиль кода, отступы, пробелы, длина строк)                     |
| "W"     | pycodestyle (предупреждения)                                                 |
| "C90"   | mccabe (сложность кода)                                                      |
| "I"     | isort (сортировка импортов)                                                  |
| "B"     | flake8-bugbear (потенциальные баги, плохие практики)                        |
| "UP"    | pyupgrade (обновление под актуальные версии Python)                          |
| "SIM"   | flake8-simplify (упрощения конструкции кода)                                 |
| "RUF"   | специальные правила ruff (в т.ч. auto-fixes)                                 |
| "ERA"   | Ищет закомментированный код (# print(...)) — рекомендуется                    |
| "T10"   | Ищет pdb, breakpoint() — рекомендуется                                        |
| "T20"   | Ищет отладочный print — особенно для продакшн                                |
| "FIX"   | Ищет # TODO, # FIXME — полезно                                               |
| "RET"   | Стиль return (избыточность) — по вкусу                                       |
| "RSE"   | Стиль raise — по вкусу                                                        |
| "BLE"   | Предупреждение о except: без указания — рекомендуется                         |
| "D"     | Проверка docstring — полезно в библиотеках                                    |
| "Q"     | Одинарные/двойные кавычки — по вкусу                                         |
| "COM"   | flake8-commas анализирует код на наличие правильного использования запятых, особенно в списках, кортежах и других структурах данных. |


----
## Примеры комманд ruff
```bash 
# Прогнать ruff по конкретному линтеру (например D):
ruff check your_file.py --select D --verbose

# Показать только коды и места ошибок
ruff check file.py --output-format concise

# Тоже самое, но сгруппировать (если много файлов)
ruff check file.py --output-format grouped

# Общая статистика
ruff check file.py --statistics

# Работа в реальном времени
ruff check file.py --watch

# Помощь можно получать и по конкретной опции
ruff help check
```

Посмотреть выводы Ruff можно и в :Telescope diagnostics  
