# Ruff

## Abstracts

Частичное и краткое описание набора линтеров Ruff, его особенностей и возможностей конфигурации.

## Table of Contents

- [About](#About)
- [Ruff linters](#Ruff-linters)
- [Configs](#Configs)
  - [Base config](#Base-config)
  - [Recommended config](#recommended-config)
- [Special comments](#Special-comments)
- [Ruff vs Black](#Ruff-vs-Black)
- [Ruff commands examples](#Ruff-commands-examples)
- [References](#References)

______________________________________________________________________

## About

Ruff - это быстрый и современный инструмент для статического анализа Python-кода.\
Он объединяет в себе множество линтеров и помогает находить и исправлять ошибки.\
Доступные в Ruff линтеры можно подключать и отключать в pyproject.toml по мере необходимости.

Впринципе, ruff умеет форматировать код, но в качестве форматтера предпочтительней использовать Black для единообразного стиля.

Ключевые преимущества Ruff:

- Скорость - написан на Rust, работает значительно быстрее flake8
- Совместимость - поддерживает правила множества существующих линтеров
- Автофикс - многие ошибки могут быть исправленны автоматически
- Конфигурируемость - гибкая настройка через pyproject.toml
- Интеграция - легко подключается к CI/CD

> [!NOTE]
>
> Зачем использовать Ruff?
> Снижает количество инструментов в проекте - заменит flake8, isort, etc
> Делает проверку кода быстрой и однородной

______________________________________________________________________

## Ruff linters

Краткое описание линтеров доступных by default для ruff 0.12.7

- Список доступных ruff линтеров можно увидеть выполнив команду:

```bash
ruff linter 
```

- Cправку по конкретному линтеру можно увидеть выполнив:

```bash
ruff linter rule <rule-name> 
```

> [!NOTE]
>
> Встроенная справка ruff может отличаться от приведенного ниже описания

**Базовые линтеры**
| Код | Инструмент | Назначение |
| --- | ------------- | ------------------------------------------------------------------------ |
| F | Pyflakes | Ошибки: неиспользуемые переменные, импорты, синтаксис — обязателен |
| E/W | pycodestyle | Стиль кода: пробелы, отступы, пустые строки — рекомендуется |
| C90 | mccabe | Сложность функций (цикломатическая) — полезно ограничить |
| I | isort | Автосортировка импортов — стандарт |
| UP | pyupgrade | Обновление синтаксиса под актуальный Python — полезно |
| RUF | Ruff-specific | Правила Ruff — auto-fix, улучшения — оставить включённым |
| COM | flake8-commas | Правильное использование запятых в списках, кортежах и структурах данных |

**Безопасность и баги**
| Код | Инструмент | Назначение |
| --- | -------------- | -------------------------------------------------------------- |
| B | flake8-bugbear | Предупреждение о потенциальных багах — рекомендуется |
| S | flake8-bandit | Безопасность: eval, subprocess и т.д. — актуально для prod |
| BLE | blind-except | Предупреждение о `except:` без указания — рекомендуется |
| FBT | boolean-trap | Подозрительные флаги в функциях — полезно, но шумно |
| TRY | tryceratops | Правильный try/except стиль — можно включить |
| SLF | self | Предупреждение о доступе к приватным атрибутам — иногда шумный |

**Упрощение и стиль**
| Код | Инструмент | Назначение |
| --- | -------------- | ---------------------------------------------------------------- |
| SIM | simplify | Упрощение конструкций — рекомендуется |
| C4 | comprehensions | Оптимизация списковых выражений — полезно |
| RET | return | Стиль `return` (избыточность) — по вкусу |
| RSE | raise | Стиль `raise` — по вкусу |
| G | logging-format | Правильные строки логирования — если активно используешь logging |
| LOG | logging | Общие ошибки при логировании — рекомендуется |
| Q | quotes | Одинарные/двойные кавычки — по вкусу |

**Документация**
| Код | Инструмент | Назначение |
| --- | ---------- | ------------------------------------------ |
| D | pydocstyle | Проверка docstring — полезно в библиотеках |
| DOC | pydoclint | Альтернатива D, иногда более строгая |

**Типизация**
| Код | Инструмент | Назначение |
| --- | ------------------ | ----------------------------------------------------------- |
| ANN | annotations | Требует type hints в функциях — полезно, если используешь |
| TC | type-checking | Перенос `import typing` под `if TYPE_CHECKING` — продвинуто |
| FA | future-annotations | Использование `from __future__ import annotations` |

**Проверки кода**
| Код | Инструмент | Назначение |
| --- | ---------- | ------------------------------------------------------------ |
| ERA | eradicate | Ищет закомментированный код (`# print(...)`) — рекомендуется |
| FIX | fixme | Ищет `# TODO`, `# FIXME` — полезно |
| TD | todos | То же самое, но шире |
| T10 | debugger | Ищет `pdb`, `breakpoint()` — рекомендуется |
| T20 | print | Ищет отладочный `print` — особенно для продакшн |

**Инфраструктура и импорт**
| Код | Инструмент | Назначение |
| --- | ------------------ | --------------------------------------------------- |
| TID | tidy-imports | Предупреждение об относительных импортов — по вкусу |
| INP | no-pep420 | Предотвращение namespace-пакетов без `__init__.py` |
| ICN | import-conventions | Именование импортов (`import numpy as np`) |

**Фреймворки и специальные случаи**
| Код | Инструмент | Назначение |
| ---- | ------------- | ------------------------------- |
| DJ | flake8-django | Для Django-проектов |
| PT | pytest-style | Для проектов с pytest |
| FAST | FastAPI | Специальные правила для FastAPI |
| AIR | Airflow | Только если пишешь DAG’и |

**Научные библиотеки**
| Код | Инструмент | Назначение |
| --- | ---------- | --------------------------------------- |
| PD | pandas-vet | Предупреждения при использовании pandas |
| NPY | numpy | Проверка стиля numpy |

**Автоматические улучшения**
| Код | Инструмент | Назначение |
| ---- | ---------- | ------------------------------------------ |
| FLY | flynt | Перевод `%`/`.format()` в f-строки |
| FURB | refurb | Умные авто-рефакторинги (экспериментально) |
| PERF | perflint | Предупреждения о неэффективном коде |

______________________________________________________________________

## Configs

#### Base config

Базовая конфигурация

```toml
select = [
    "E", "F", "D", "Q", "COM"
]
```

#### Recommended config

Рекомендуемая конфигурация

```toml
select = [ 
    "F", "E", "W", "C90", "I", 
    "B", "UP", "SIM", "RUF", "ERA", 
    "T10", "T20", "FIX", "RET", "RSE", 
    "BLE", "D", "Q", "COM", 
]
```

Краткое описание конфигурации
| **Код** | **Описание** |
|---------|-------------------------------------------------------------------------------|
| "F" | Pyflakes (ошибки, неиспользуемые переменные и импорты) |
| "E" | pycodestyle (стиль кода, отступы, пробелы, длина строк) |
| "W" | pycodestyle (предупреждения) |
| "C90" | mccabe (сложность кода) |
| "I" | isort (сортировка импортов) |
| "B" | flake8-bugbear (потенциальные баги, плохие практики) |
| "UP" | pyupgrade (обновление под актуальные версии Python) |
| "SIM" | flake8-simplify (упрощения конструкции кода) |
| "RUF" | специальные правила ruff (в т.ч. auto-fixes) |
| "ERA" | Ищет закомментированный код (# print(...)) — рекомендуется |
| "T10" | Ищет pdb, breakpoint() — рекомендуется |
| "T20" | Ищет отладочный print — особенно для продакшн |
| "FIX" | Ищет # TODO, # FIXME — полезно |
| "RET" | Стиль return (избыточность) — по вкусу |
| "RSE" | Стиль raise — по вкусу |
| "BLE" | Предупреждение о except: без указания — рекомендуется |
| "D" | Проверка docstring — полезно в библиотеках |
| "Q" | Одинарные/двойные кавычки — по вкусу |
| "COM" | flake8-commas анализирует код на наличие правильного использования запятых, особенно в списках, кортежах и других структурах данных. |

______________________________________________________________________

## Special comments

**#ruff: noqa**

- Используется для игнорирования предупреждений на конкретной строке. Это позволяет отключить определенные проверки для этой строки.

```python
x = "string"  # ruff: noqa
```

**#ruff: ignore(code)**

- Игнорирует конкретный код ошибки для данной строки. Например, # ruff: ignore[E501] игнорирует предупреждение о превышении максимальной длины строки.

```python
long_variable_name = "This is a very long string that exceeds the maximum line length"  # ruff: ignore[E501]
```

**#TODO**

- Используется для пометки участков кода, которые требуют доработки. Ruff может распознавать такие комментарии и сообщать о них.

```python
# TODO: Implement this function
```

**#FIXME**

- Указывает на проблемы или ошибки в коде, которые необходимо исправить. Ruff также может распознавать эти комментарии.

```python
# FIXME: This logic is incorrect
```

**#ruff: on/off**

- Позволяет включать или отключать определенные проверки для всего файла или блока кода.

```python
# ruff: off
# Some code that should not be checked
# ruff: on

```

______________________________________________________________________

## Ruff vs Black

Форматирование ruff не сможет всегда обеспечить единообразие кода так, как это сделает black.
А цель форматирования как раз в единообразии.

**Black:**\
Миссия: обеспечить единообразный стиль всего кода, без субъективных решений.\
Поведение: "Code formatter" (Полное форматирование).\
Стиль: Единый, строгий, неизменяемый.\
Автофиксы: Форматирует всё.\
Настраиваемость: Почти нет (ведет себя почти всегда одинаково).\
Работает как механическая перестройка кода: переносы строк, пробелы, скобки, отступы — всё по строгим правилам.\
Игнорирует «красоту» или предпочтения — просто делает однозначно правильное по его правилам форматирование.

```python
# до black:
def func(x,y):return(x + y)

# после black:
def func(x, y):
    return x + y
```

**Ruff:**\
Миссия: линтинг, т.е. поиск проблем в стиле, структуре, ошибках.\
Поведение: "Linter with fixer".\
Стиль: Конфигурируемый через правила.\
Автофиксы: Только отдельные нарушения.\
Настраиваемость: Много правил, можно включать/выключать.\
Может **частично** исправлять стиль: убрать лишние пробелы, двойные кавычки, пустые строки, и т. д.\
Следует правилам PEP8 + наборам правил (E, F, I, W, UP, и др.).\
Не делает глубокого форматирования, как переносы длинных строк или преобразование однострочных функций в многострочные.

```python
# до ruff --fix:
def func(x , y):   return  ( x + y )

# после:
def func(x, y):
    return (x + y)  # скобки останутся, переносов строки — нет
```

Ruff — это вообще не форматтер, а инструмент для линтинга Python-кода, который может автоматически исправлять часть нарушений стиля, но не является полноценным форматтером.

______________________________________________________________________

## Ruff commands examples

```bash
# Прогнать ruff по конкретному линтеру (например D):
ruff check your_file.py --select D --verbose

# Показать только коды и места ошибок
ruff check file.py --output-format concise

# Тоже самое, но сгруппировать (если много файлов)
ruff check file.py --output-format grouped

# Общая статистика
ruff check file.py --statistics

# Работа в реальном времени
ruff check file.py --watch

# Помощь можно получать и по конкретной опции
ruff help check
```

Посмотреть выводы Ruff можно и в :Telescope diagnostics

______________________________________________________________________

## References

[Ruff web docs](https://docs.astral.sh/ruff/)\
[Ruff Github page](https://github.com/astral-sh/ruff)
